const ws_scheme=window.location.protocol==="https:"?"wss":"ws",timelimit_el=document.getElementById("time-limit"),surrenderBtn=document.getElementById("surrender-btn"),overlay=document.getElementById("game-settings-overlay"),highlightMoves_el=document.getElementById("highlight-moves"),closeRoleDialog_el=document.getElementById("closeRoleDialog");window.showDialog=function(t,e=null){if(!(localStorage.getItem("hide"+t+"Dialog")==="true")){t==="role"&&(e==="black"?document.getElementById(t+"-dialog-content").textContent=lang.roleDialogB:document.getElementById(t+"-dialog-content").textContent=lang.roleDialogW),document.getElementById(t+"-dialog").style.display="block",document.getElementById(t+"-dialog-overlay").style.display="block";let n=null;if(t==="role"&&(n=document.getElementById("closeRoleDialog")),n){const l=i=>{i.key==="Enter"&&n.click()};document.addEventListener("keydown",l),n.addEventListener("click",()=>{document.removeEventListener("keydown",l)})}}},window.closeDialog=function(t){document.getElementById(t+"-dialog").style.display="none",document.getElementById(t+"-dialog-overlay").style.display="none",localStorage.setItem("hide"+t+"Dialog",document.getElementById(t+"-not-checkbox").checked)};function __DOMContentLoaded(){makeSocket(),localStorage.setItem("deleted_urls",JSON.stringify([])),document.getElementById("next-move-btn").style.display="none"}function processPassMessage(t){console.log(`[processPassMessage] Received pass message: ${JSON.stringify(t)}, old currentPlayer: ${currentPlayer}`),currentPlayer=t.new_turn,currentPlayer===role_online?alert(lang.opponent_pass):alert(lang.you_pass),updateStatus()}window.sendMove=function(t,e){const o={action:"place_stone",row:t,col:e,player:currentPlayer};console.log("Sending WebSocket move:",o),socket.send(JSON.stringify(o))};function updatePlayerList(t){console.log(`[updatePlayerList] Updating player list: ${JSON.stringify(t)}`);const e=document.getElementById("player-list");if(e.innerHTML="",Object.entries(t).forEach(([o,[n,l]])=>{const i=n==="black"?lang.black:n==="white"?lang.white:lang.spec,a=document.createElement("span");let s;o===playerId?(a.style.fontWeight="bold",s=lang.you+`\uFF08${l}\uFF09`):(s=l,n!=="spectator"&&(opponentName=l)),a.innerHTML=(i!==lang.black?"\u3000":"")+`${i===lang.black?'<span id="black_circle"></span>':i===lang.white?'<span id="white_circle"></span>':i+":"} ${escapeHTML(s)}`,e.appendChild(a)}),Object.keys(t).length===1){const o=document.createElement("span");o.innerHTML='\u3000<span id="white_circle"></span> '+lang.opponent,e.appendChild(o)}}function sendSettings(){let t=timelimit_el.value,e=highlightMoves_el.checked;timeLimit=t,showValidMoves=e?"true":"false",localStorage.setItem("timeLimit",timeLimit),localStorage.setItem("showValidMoves",showValidMoves),window.socket.send(JSON.stringify({action:"game_setting",time_limit:timeLimit,show_valid_moves:showValidMoves,player_name:playerName}))}function toHalfWidth(t){return t.replace(/[Ａ-Ｚａ-ｚ０-９]/g,function(e){return String.fromCharCode(e.charCodeAt(0)-65248)})}function escapeHTML(t){return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}window.makeSocket=function(){socket=new WebSocket(`${ws_scheme}://${window.location.host}/ws/othello/${gameRoom}/?playerId=${playerId}&timeLimit=${timeLimit}&showValidMoves=${showValidMoves}&playerName=${encodeURIComponent(playerName)}&lang=${langCode}`),window.socket.onopen=function(t){console.log("WebSocket connection established.",t)},window.socket.onmessage=function(t){console.log("WebSocket message received:",t.data);const e=JSON.parse(t.data);if(e.error){alert(`\u26A0\uFE0F ${e.error}`);return}if(e.action==="place_stone")board.innerHTML="",refreshBoard(),add4x4Markers(),deserializeMoveHistory(e.history),console.log("moveHistory",moveHistory),replayMovesUpToIndex(moveHistory.length-1,1);else if(e.action==="assign_role")role_online=e.role,console.log(`\u3042\u306A\u305F\u306E\u5F79\u5272: ${role_online}, \u30C7\u30FC\u30BF${e}, (ID: ${playerId}), \u518D\u63A5\u7D9A${e.reconnect}, \u30ED\u30FC\u30EB${role_online}`),e.n_players===1&&(overlay.style.display="flex"),e.reconnect===!0?(board.innerHTML="",refreshBoard(),add4x4Markers(),deserializeMoveHistory(e.history),console.log("moveHistory",moveHistory),replayMovesUpToIndex(moveHistory.length-1,2),stopTimer(),document.getElementById("timer-display").textContent="- : --",timeLimit=e.time_limit,localStorage.setItem("timeLimit",timeLimit),document.getElementById("timeLimitSelect").value=timeLimit,console.log(`\u30B2\u30FC\u30E0\u304C\u518D\u958B\u3055\u308C\u307E\u3057\u305F\u3002${e.show_valid_moves}`),showValidMoves=e.show_valid_moves==="true",localStorage.setItem("showValidMoves",showValidMoves),document.getElementById("showValidMovesCheckbox").checked=showValidMoves,timeLimit===0?document.getElementById("timeLimitBox_").style.display="none":document.getElementById("timeLimitBox_").style.display="block",e.n_players!==1&&(document.getElementById("restart-btn").disabled=!1,surrenderBtn.disabled=!1),console.log("reconnect",e)):(timeLimit=0,localStorage.setItem("timeLimit",timeLimit),stopTimer(),document.getElementById("timeLimitBox_").style.display="none");else if(e.action==="update_players"){if(updatePlayerList(e.players),e.by_reconnect)return;if(Object.keys(e.players).length===2&&!e.setting){role_online==="black"&&sendSettings(),showDialog("role",role_online),overlay.style.display="none";const o=document.getElementById("qr-popup");o.style.display="none",highlightValidMoves(),document.getElementById("restart-btn").disabled=!1,surrenderBtn.disabled=!1}if(playerJoinSoundEnabled&&e.player_id!==playerId&&(playerJoin.currentTime=0,playerJoin.play().catch(o=>{console.warn("audio was blocked:",o)})),e.setting){stopTimer(),timeLimit=e.time_limit,localStorage.setItem("timeLimit",timeLimit),document.getElementById("timeLimitSelect").value=timeLimit,showValidMoves=e.show_valid_moves==="true",localStorage.setItem("showValidMoves",showValidMoves),document.getElementById("showValidMovesCheckbox").checked=showValidMoves;const o=document.getElementById("timer-display");timeLimit===0?(document.getElementById("timeLimitBox_").style.display="none",o.style.display="none"):(document.getElementById("timeLimitBox_").style.display="block",o.style.display="block",o.textContent=formatTime(timeLimit))}}else if(e.action==="pass"){processPassMessage(e);return}else if(e.action==="game_over"){endGame(e,e.winner);return}else if(e.action==="game_start"){console.log(`Game started. ${e.time_limit},${e.show_valid_moves}.`),onlineGameStarted=!0;return}}},surrenderBtn&&(surrenderBtn.addEventListener("click",()=>{confirm(lang.surrender_right)&&socket.send(JSON.stringify({action:"surrender"}))}),document.getElementById("info-button").addEventListener("click",function(){alert(`${lang.how2play_with_friend}`)}));const playerName_el=document.getElementById("player-name");if(playerName_el){playerName_el.value=playerName;const t=document.getElementById("warning");playerName_el.addEventListener("change",()=>{const e=toHalfWidth(playerName_el.value.trim());e.length>0?(playerName_el.value=e,/^[a-zA-Z0-9]+$/.test(e)?(playerName=profanityCleaner.clean(e),document.getElementById("player-list").children[0].innerHTML='<span id="black_circle"></span> '+lang.you+"("+escapeHTML(playerName)+")",playerName_el.value=playerName,localStorage.setItem("playerName",playerName),t.textContent=""):t.textContent=lang.warn_EnOnly):t.textContent=lang.warn_charLimit})}document.readyState!=="loading"?(document.removeEventListener("DOMContentLoaded",__DOMContentLoaded),__DOMContentLoaded()):window.addEventListener("DOMContentLoaded",__DOMContentLoaded),closeRoleDialog_el&&(closeRoleDialog_el.addEventListener("click",()=>{closeDialog("role")}),document.getElementById("role-dialog-overlay").addEventListener("click",()=>{closeDialog("role")}));
