const C=new Worker(workerPath);export function startAIMove(){aimove=!0,stopTimer();const n=document.getElementById("timer-display");n.classList.remove("warning1","warning2"),n.style.display="inline-block";const e=aiLevel===6?"\u{1F424} ":aiLevel===9?"\u{1F47A} ":aiLevel===7?"\u{1F506} ":aiLevel>9?"\u{1F308} ":"\u{1F914} ";n.textContent=e+lang.thinking,board.classList.add("thinking"),setTimeout(()=>{updateStatus(),$(),updateURL()},10);const t=setInterval(()=>{if(aimove)n.textContent===e+lang.thinking?n.textContent=e+lang.thinking+".":n.textContent===e+lang.thinking+"."?n.textContent=e+lang.thinking+"..":n.textContent===e+lang.thinking+".."?n.textContent=e+lang.thinking+"...":n.textContent===e+lang.thinking+"..."&&(n.textContent=e+lang.thinking);else{clearInterval(t);return}},700)}function p(n,e){return 1n<<BigInt(n*8+e)}function F(n){let e=0n,t=0n;for(let s=0;s<8;s++)for(let c=0;c<8;c++){const r=p(s,c);n[s][c]==="black"?e|=r:n[s][c]==="white"&&(t|=r)}return{black:e,white:t}}const O=[{dRow:0,dCol:-1},{dRow:-1,dCol:-1},{dRow:-1,dCol:0},{dRow:-1,dCol:1},{dRow:0,dCol:1},{dRow:1,dCol:1},{dRow:1,dCol:0},{dRow:1,dCol:-1}];function R(n,e,t,s){const c=s?n:e,r=s?e:n,l=p(t.row,t.col);if((c|r)&l)return 0n;let o=0n;for(const{dRow:i,dCol:a}of O){let u=t.row+i,d=t.col+a,L=0n,f=!1;for(;u>=0&&u<8&&d>=0&&d<8;){const x=p(u,d);if((x&r)!==0n)L|=x,f=!0;else if((x&c)!==0n){f&&(o|=L);break}else break;u+=i,d+=a}}return o}function h(n,e,t){const r=~((t?n:e)|(t?e:n))&0xFFFFFFFFFFFFFFFFn;let l=[];for(let o=0;o<8;o++)for(let i=0;i<8;i++){const a=p(o,i);if(r&a){const u=R(n,e,{row:o,col:i},t);u!==0n&&l.push({row:o,col:i,flipped:u})}}return l}function I(n,e,t,s,c){const r=p(t.row,t.col);return c?{black:n|r|s,white:e&~s}:{black:n&~s,white:e|r|s}}function $(){let n={row:null,col:null};const e=gameBoard.map(s=>[...s]),t=F(e);if(window.Worker)C.postMessage([t,minimax_depth,aiLevel]),C.onmessage=function(s){let c;[n.row,n.col,c]=s.data,minimax_depth=c,console.log(`AI Move:${n}, Depth:${minimax_depth}`),aiLevel<4?setTimeout(()=>y(n,timeLimit,gameEnded,aimove),600):aiLevel<7?setTimeout(()=>y(n,timeLimit,gameEnded,aimove),300):y(n,timeLimit,gameEnded,aimove)},C.onerror=function(s){console.error("Error in AI worker:",s.message)};else{const s=performance.now();let c=-1/0;const r=!0,l=h(t.black,t.white,!r);for(let o=0;o<l.length;o++){const i=l[o],a=I(t.black,t.white,i,i.flipped,!r),u=k(a.black,a.white,minimax_depth,!1,-1/0,1/0);if(u>c&&(c=u,n={row:i.row,col:i.col}),o===Math.floor(l.length/2)){const d=performance.now();T((d-s)*2,aiLevel)}}aiLevel<=3?setTimeout(()=>y(n,timeLimit,gameEnded,aimove),600):y(n,timeLimit,gameEnded,aimove)}}function y(n,e,t,s){n.row!==null&&makeMove(n.row,n.col,2),e>0&&!t?startTimer():document.getElementById("timer-display").style.display="none",s&&board.classList.remove("thinking"),aimove=!1}function k(n,e,t,s,c=-1/0,r=1/0){if(t<=0)return W(n,e);const l=!s,o=h(n,e,l);if(o.sort((i,a)=>E(a)-E(i)),o.length===0)return h(n,e,!l).length===0?D(n,e):k(n,e,t-1,!s,c,r);if(s){let i=-1/0;for(const a of o){const u=I(n,e,a,a.flipped,l),d=k(u.black,u.white,t-1,!1,c,r);if(i=Math.max(i,d),c=Math.max(c,d),r<=c)break}return i}else{let i=1/0;for(const a of o){const u=I(n,e,a,a.flipped,l),d=k(u.black,u.white,t-1,!0,c,r);if(i=Math.min(i,d),r=Math.min(r,d),r<=c)break}return i}}function E(n){const e=n.row,t=n.col;return e===0&&t===0||e===7&&t===0||e===0&&t===7||e===7&&t===7?1e3:e===2&&t===0||e===5&&t===0||e===0&&t===2||e===7&&t===2||e===0&&t===5||e===7&&t===5||e===2&&t===7||e===5&&t===7?900:e===3&&t===0||e===4&&t===0||e===0&&t===3||e===7&&t===3||e===0&&t===4||e===7&&t===4||e===3&&t===7||e===4&&t===7?800:e===2&&t===2||e===2&&t===5||e===5&&t===2||e===5&&t===5?700:e===2&&t===3||e===2&&t===4||e===3&&t===2||e===4&&t===2||e===5&&t===3||e===5&&t===4||e===3&&t===5||e===4&&t===5?600:e===2&&t===1||e===3&&t===1||e===4&&t===1||e===5&&t===1||e===1&&t===2||e===6&&t===2||e===1&&t===3||e===6&&t===3||e===1&&t===4||e===6&&t===4||e===1&&t===5||e===6&&t===5||e===2&&t===6||e===3&&t===6||e===4&&t===6||e===5&&t===6?500:e===1&&t===0||e===6&&t===0||e===0&&t===1||e===7&&t===1||e===0&&t===6||e===7&&t===6||e===1&&t===7||e===6&&t===7?400:e===1&&t===1||e===6&&t===1||e===1&&t===6||e===6&&t===6?300:0}function T(n,e){n<e*200?minimax_depth++:n>e*400&&(minimax_depth--,n>e*700&&minimax_depth--),minimax_depth>e&&(minimax_depth=e),minimax_depth<0&&(minimax_depth=0)}function m(n){let e=0n,t=n;for(;t;)e++,t&=t-1n;return Number(e)}function D(n,e){const t=m(n);return(m(e)-t)*1e3}const A=0x8100000000000081n,S=0x7E8181818181817En,_=30,M=5,w=7,P=aiLevel>5?.3:.1;function W(n,e){let t=0,s=0;const c=m(n),r=m(e),o=(c+r)/64,i=o*2+.1;t+=c*i,s+=r*i;const a=m(n&A),u=m(e&A);t+=a*_,s+=u*_;const d=m(n&S),L=m(e&S);t+=d*M,s+=L*M;const f=Math.max(0,1-o*1.1),x=[{corner:0x0000000000000001n,xc:0x0000000000000202n},{corner:0x0000000000000080n,xc:0x0000000000004000n},{corner:0x0100000000000000n,xc:0x0200000000000000n},{corner:0x8000000000000000n,xc:0x4040000000000000n}];for(const{corner:v,xc:g}of x)(n&v)===0n&&(e&v)===0n?(t-=m(n&g)*w*f,s-=m(e&g)*w*f):n&v?s-=m(e&g)*w*.8*f:e&v&&(t-=m(n&g)*w*.8*f);if(o<.7){const v=(1-o)*P,g=h(n,e,!0).length,N=h(n,e,!1).length;t+=g*v,s+=N*v}return aiLevel>1?aiLevel===6?t-s:s-t:r-c}export function initAIMode(){if(aiLevel>9&&!authenticated){const l=new URL(window.location);l.searchParams.set("next",l),l.pathname=(langCode==="ja"?"":"/"+langCode)+"/signup/",history.pushState(null,"",location.href),location.href=l.toString();return}const n=document.getElementById("aiLevelSelect");document.getElementById("ai-level-display").addEventListener("click",function(){const l=document.getElementById("ai-level-popup");l.style.display=l.style.display!=="block"?"block":"none",localStorage.setItem("aiLevel",n.value),aiLevel=n.value,minimax_depth=aiLevel-4,minimax_depth<0&&(minimax_depth=0),c()});const e=JSON.parse(localStorage.getItem("unlockedAiLevels")||'{"0":true,"1":true,"2":true,"6":true}');console.log(`[aiLevelSelect] Unlocked levels: ${JSON.stringify(e)}`);const t=Math.max(...Object.keys(e).map(Number));if(t>=9){const l=document.getElementById("ai-level-list");for(let o=11;o<=t+2;o+=2){const i=document.createElement("option"),a=document.createElement("div");i.value=o,i.setAttribute("data-unlock-level",o-2),i.className="locked-level",o===11?(i.textContent=`\u{1F308} ${lang.legend}`,a.textContent=`\u{1F308} ${lang.legend}`):(i.textContent=`\u{1F308} ${lang.legend} ${(o-9)/2}`,a.textContent=`\u{1F308} ${lang.legend} ${(o-9)/2}`),a.className="ai-level-item locked-level",a.setAttribute("data-level",o),a.setAttribute("data-unlock-level",o-2),n.insertBefore(i,n.lastChild),l.insertBefore(a,l.lastChild)}Object.keys(e).length===8?langNextAIName=`\u{1F308} ${lang.legend}`:langNextAIName=`\u{1F308} ${lang.legend} ${(t-7)/2}`}document.querySelectorAll(".locked-level").forEach(l=>{const o=l.getAttribute("data-unlock-level");if(e[l.getAttribute("data-level")||l.value])l.classList.remove("locked-level"),l.disabled=!1,l.style.display="";else if(e[o]){const i=document.querySelector('#aiLevelSelect option[value="'+o+'"]');switch(l.getAttribute("data-level")&&(langNextAIName=l.textContent),langCode){case"en":o>=9&&!authenticated?l.textContent="Sign up to unlock the next level":l.textContent=`Next Level: Defeat ${i.textContent} to unlock`;break;default:o>=9&&!authenticated?l.textContent="\u6B21\u306E\u30EC\u30D9\u30EB : \u30A2\u30AB\u30A6\u30F3\u30C8\u3092\u767B\u9332\u3057\u3066\u89E3\u653E":l.textContent=`\u6B21\u306E\u30EC\u30D9\u30EB : ${i.textContent}AI\u306B\u52DD\u5229\u3067\u89E3\u653E`;break}l.disabled=!0}else l.style.display="none"}),window.unlockNextAiLevel=function(l){const o=Array.from(n.querySelectorAll(".locked-level")).find(a=>a.getAttribute("data-unlock-level")==l),i=Number(l);if(o){const a=o.value;e[a]=!0,localStorage.setItem("unlockedAiLevels",JSON.stringify(e)),document.getElementById("restart-match").textContent=lang.nextLevel,localStorage.setItem("aiLevel",a)}else if(i>=9){const a=i+2;e[a]=!0,localStorage.setItem("unlockedAiLevels",JSON.stringify(e)),document.getElementById("restart-match").textContent=lang.nextLevel,localStorage.setItem("aiLevel",a)}},window.congratsNextAiLevel=function(l){(Array.from(n.querySelectorAll(".locked-level")).find(i=>i.getAttribute("data-unlock-level")==l)||l>=9)&&alert(lang.congrats_aiLevel_unlocked_b+langNextAIName+lang.congrats_aiLevel_unlocked_a)};function c(){const l=document.getElementById("ai-level-display");n.value=aiLevel;try{l.textContent=n.options[n.selectedIndex].text+(aiLevel>9?"":" AI")}catch(i){l.textContent=`\u{1F319} Level ${aiLevel}`,console.warn("\u96A0\u3057\u30EC\u30D9\u30EB | error:",i)}document.querySelectorAll(".ai-level-item").forEach(i=>{i.getAttribute("data-level")===n.value?i.classList.add("selected"):i.classList.remove("selected")})}document.querySelectorAll(".ai-level-item").forEach(l=>{l.addEventListener("click",function(){if(this.classList.contains("locked-level"))return;const o=this.getAttribute("data-level");n.value=o;const i=new Event("change");n.dispatchEvent(i),c(),document.getElementById("ai-level-popup").style.display="none";const a=new URL(window.location);a.searchParams.delete("moves"),a.searchParams.delete("won"),a.searchParams.set("aiLevel",o),history.pushState(null,"",a),location.reload()})}),document.addEventListener("click",function(l){const o=document.getElementById("ai-level-popup");o.style.display==="block"&&!o.contains(l.target)&&l.target!==document.getElementById("ai-level-display")&&(o.style.display="none")}),n.addEventListener("change",c),setTimeout(c,100)}
