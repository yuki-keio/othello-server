window.board=document.getElementById("board");const statusB=document.getElementById("status"),scoreB=document.getElementById("score_black"),scoreW=document.getElementById("score_white"),turnDisplay=document.getElementById("turn_display"),moveListElement=document.getElementById("move-list"),copyUrlBtn=document.getElementById("copy-url-btn");let aiModulePromise=null,aiModule=null;const aiPath=DEBUG_MODE?"./ai.js":"./ai.min.js",workerPath=DEBUG_MODE?"/static/game/worker.js":"/static/game/worker.min.js";window.playerJoin=document.getElementById("playerJoin");const warningSound=document.getElementById("warningSound"),victorySound=document.getElementById("victorySound"),defeatSound=document.getElementById("defeatSound"),audioContext=new(window.AudioContext||window.webkitAudioContext);let placeStoneBuffer=null,placeStoneBufferPromise=null,lastPlayTime=0,gainNode=audioContext.createGain();gainNode.connect(audioContext.destination),gainNode.gain.value=.09;let resumed=null;window.onlineGameStarted=!1;let deferredPrompt;const startMatchBtn=document.getElementById("start-match");window.playerName=localStorage.getItem("playerName"),playerName||(playerName="player"+Math.floor(Math.random()*1e3),localStorage.setItem("playerName",playerName)),window.playerId=localStorage.getItem("playerId"),playerId||(playerId=crypto.randomUUID(),localStorage.setItem("playerId",playerId));const gUrlParams=new URLSearchParams(window.location.search);window.gameRoom=gUrlParams.get("room"),window.socket=null;let soundEffects=localStorage.getItem("soundEffects")!=="false",timeLimitSoundEnabled=localStorage.getItem("timeLimitSoundEnabled")!=="false",gameEndSoundEnabled=localStorage.getItem("gameEndSoundEnabled")!=="false";window.playerJoinSoundEnabled=localStorage.getItem("playerJoinSoundEnabled")!=="false",window.showValidMoves=localStorage.getItem("showValidMoves")!=="false",window.timeLimit=parseInt(localStorage.getItem("timeLimit")||0);let aiLevel=parseInt(localStorage.getItem("aiLevel")||1);console.log(`AI Level:${aiLevel}, aiLevelSelect:${document.getElementById("aiLevelSelect").value}, localStorage:${localStorage.getItem("aiLevel")}`),window.currentPlayer="black";let gameBoard=Array.from({length:8},()=>Array(8).fill(""));window.moveHistory=[];let currentMoveIndex=-1,lastMoveCell=null,gameFinishedCount=parseInt(localStorage.getItem("gameFinishedCount")||0),minimax_depth=aiLevel-4;minimax_depth<0&&(minimax_depth=0);let currentPlayerTimer,gameEnded=!1,share_winner="",ifVictory=!1;window.langCode="ja";let gameMode=window.location.pathname.split("/").filter(Boolean)[0]||"player";gameMode==="en"&&(gameMode=window.location.pathname.split("/").filter(Boolean)[1]||"player",langCode="en");const l_prefix=langCode==="ja"?"":"/"+langCode;let langNextAIName=!1,aimove=!1,online=!1;window.role_online="unknown",window.opponentName=void 0;const rPopup=document.getElementById("result-popup"),rBoverlay=document.getElementById("r-background-overlay"),resultImg=document.getElementById("result-image"),scoreDiff=document.getElementById("score-difference"),rMessage=document.getElementById("r-message"),rOverlay=document.getElementById("r-overlay");let authenticated=!1,loggedInBefore=localStorage.getItem("loggedInBefore")==="true";const DIRECTIONS=[[-1,-1],[-1,0],[-1,1],[0,-1],[0,1],[1,-1],[1,0],[1,1]];window.refreshBoard=function(){const e=document.createDocumentFragment();for(let t=0;t<8;t++){const n=document.createElement("div");n.className="row",n.setAttribute("role","row");for(let o=0;o<8;o++){gameBoard[t][o]="";const l=document.createElement("div");l.className="cell",l.dataset.row=t,l.dataset.col=o,l.setAttribute("aria-label","abcdefgh"[o]+`${t+1}\uFF1A\u7A7A`),l.setAttribute("role","gridcell"),n.appendChild(l)}e.appendChild(n)}board.appendChild(e)},board.addEventListener("click",e=>{if(!aimove){const t=e.target.closest(".cell");if(!t)return;const n=parseInt(t.dataset.row,10),o=parseInt(t.dataset.col,10);makeMove(n,o)}});function initializeBoard(){refreshBoard(),loadBoardFromURL()||setInitialStones(),add4x4Markers(),updateStatus()}function setInitialStones(){setDisc(3,3,"white"),setDisc(3,4,"black"),setDisc(4,3,"black"),setDisc(4,4,"white")}window.add4x4Markers=function(){[{row:1,col:1},{row:1,col:5},{row:5,col:1},{row:5,col:5}].forEach(({row:t,col:n})=>{const o=board.children[t].children[n],l=document.createElement("div");l.className="marker",o.classList.add("markerPosition"),o.appendChild(l)}),document.getElementById("b_loader").style.display="none"};function setDisc(e,t,n){gameBoard[e][t]=n;const o=board.children[e].children[t];for(;o.firstChild;)o.removeChild(o.firstChild);const l=document.createElement("div");if(o.classList.contains("markerPosition")){l.classList.add("disc","markerPosition",n);const i=document.createElement("div");i.classList.add("marker"),o.append(l,i)}else l.classList.add("disc",n),o.append(l);o.setAttribute("aria-label","abcdefgh"[t]+`${e+1}\uFF1A${n==="black"?lang.black:lang.white}`)}function notifyNoValidMoves(e){if(online)if(role_online===e){alert(lang.you_pass);return}else{alert(lang.opponent_pass);return}alert(e==="black"?lang.notify_b:lang.notify_w)}function isBoardFull(){return gameBoard.flat().every(e=>e!=="")}async function applyServerMove(e,t,n,o,l=!1){if(gameBoard[e][t]!==""||!isValidMove(e,t,n)){console.warn(`[applyServerMove] Invalid move: (${e},${t}), gameBoard[${e}][${t}]: ${gameBoard[e][t]}, isValidMove: ${isValidMove(e,t,n)}`);return}lastMoveCell&&lastMoveCell.classList.remove("last-move"),setDisc(e,t,n),soundEffects&&(o!==1||l)&&playStoneSound();const i=board.children[e].children[t];i.firstChild.classList.add("last-move"),lastMoveCell=i.firstChild,flipDiscs(e,t,n),recordMove(e,t,o),!online&&isBoardFull()?o!==1&&endGame("offline"):(currentPlayer=n==="black"?"white":"black",hasValidMove(currentPlayer)||(online?role_online===currentPlayer&&l===1&&socket.send(JSON.stringify({action:"pass"})):(o!==1&&(o===0||o===1?notifyNoValidMoves(currentPlayer):o===2&&alert(lang.you_pass)),aimove=!1),currentPlayer=currentPlayer==="black"?"white":"black",console.log(`[applyServerMove] No valid moves. SO currentP became: ${currentPlayer}`),hasValidMove(currentPlayer)?updateStatus():online||endGame("offline"))),gameMode==="ai"&&currentPlayer==="white"&&!gameEnded&&o!==1&&aimove===!1?aiModulePromise.then(a=>{aiModule=a,aiModule.startAIMove()}).catch(a=>{console.error("Error loading AI module:",a)}):(l!==!1||!online)&&updateURL(),(l!==!1||!online)&&updateStatus()}function makeMove(e,t,n=0){if(!gameEnded){if(n===1){applyServerMove(e,t,currentPlayer,n);return}if(online)if(role_online==="unknown"){alert(lang.connecting);return}else if(role_online==="spectator"){alert(lang.spec_cant_play);return}else if(role_online===currentPlayer)window.sendMove(e,t);else{const o=role_online==="black"?lang.black:role_online==="white"?lang.white:lang.spec;alert(`${lang.not_your_turn}${currentPlayer==="black"?lang.black:lang.white}, ${lang.you}\uFF1A${o}`);return}else applyServerMove(e,t,currentPlayer,n)}}function isValidMove(e,t,n=currentPlayer){if(gameBoard[e][t]!=="")return!1;for(const[o,l]of DIRECTIONS)if(wouldFlip(e,t,o,l,n))return[e,t];return!1}function wouldFlip(e,t,n,o,l=currentPlayer){let i=e+n,a=t+o;if(!isValidPosition(i,a)||gameBoard[i][a]!==getOpponentColor(l))return!1;for(;isValidPosition(i,a)&&gameBoard[i][a]===getOpponentColor(l);)i+=n,a+=o;return isValidPosition(i,a)&&gameBoard[i][a]===l}function flipDiscs(e,t,n=currentPlayer){for(const[o,l]of DIRECTIONS)if(wouldFlip(e,t,o,l,n)){let i=e+o,a=t+l;for(;gameBoard[i][a]===getOpponentColor(n);)setDisc(i,a,n),i+=o,a+=l}}function isValidPosition(e,t){return e>=0&&e<8&&t>=0&&t<8}function getOpponentColor(e=currentPlayer){return e==="black"?"white":"black"}function hasValidMove(e=currentPlayer){const t=[];for(let n=0;n<8;n++)for(let o=0;o<8;o++)if(gameBoard[n][o]===""){const l=isValidMove(n,o,e);l&&t.push(l)}return t.length>0?t:!1}window.highlightValidMoves=function(){removeHighlight();const e=hasValidMove();e&&(e.map(([n,o])=>board.children[n].children[o]).forEach(n=>{n.classList.add("valid-move");const o=document.createElement("div");o.className=`faint-disc faint-${currentPlayer}`,n.appendChild(o)}),(gameMode==="ai"&&currentPlayer==="white"||online&&role_online!==currentPlayer&&(gameBoard.flat().filter(n=>n!=="").length!==4||role_online==="white"))&&board.classList.add("opponent-turn"))};function removeHighlight(){document.querySelectorAll(".valid-move").forEach(t=>{const n=t.querySelector(".faint-disc");n&&n.remove(),t.classList.remove("valid-move")}),board.classList.remove("opponent-turn")}function updateStatus(){const e=gameBoard.flat().filter(n=>n==="black").length,t=gameBoard.flat().filter(n=>n==="white").length;if(scoreB.textContent=e,scoreW.textContent=t,currentPlayer==="black"?(statusB.style.backgroundColor="#000",turnDisplay.textContent=lang.black_turn):(statusB.style.backgroundColor="#fff",turnDisplay.textContent=lang.white_turn),showValidMoves||showValidMoves==="true"?highlightValidMoves():removeHighlight(),!aimove){const n=document.getElementById("timer-display");timeLimit>0?(n.style.display="inline-block",gameEnded||startTimer()):(n.style.display="none",stopTimer())}}function startTimer(){let e=timeLimit;const t=document.getElementById("timer-display");t.textContent=formatTime(e),t.classList.remove("warning1"),t.classList.remove("warning2"),stopTimer(),gameBoard.flat().filter(n=>n!=="").length!==4&&(warningSound.currentTime=0,currentPlayerTimer=setInterval(()=>{e--,t.textContent=formatTime(e),e<4&&timeLimitSoundEnabled&&warningSound.play().catch(n=>{console.warn("audio was blocked:",n)}),e<=5?(t.classList.remove("warning1"),t.classList.add("warning2")):e<=15?t.classList.add("warning1"):(t.classList.remove("warning1"),t.classList.remove("warning2")),e<=0&&(clearInterval(currentPlayerTimer),online||(alert(lang.timeout_winner+(currentPlayer==="black"?lang.white:lang.black)),endGame("offline",currentPlayer==="black"?"white":"black")))},1e3))}window.stopTimer=function(){currentPlayerTimer&&(clearInterval(currentPlayerTimer),currentPlayerTimer=null,warningSound.pause())},window.formatTime=function(e){const t=Math.floor(e/60),n=e%60;return`${t}:${n<10?"0":""}${n}`};function isIOS(){return/iPhone|iPad|iPod/.test(navigator.userAgent)}function recordMove(e,t,n){const l=`${"abcdefgh"[t]}${e+1}`;n!==1&&(moveHistory.push({row:e,col:t,player:currentPlayer,moveNotation:l,token:"recordMove"}),localStorage.setItem("deleted_urls",JSON.stringify([])),document.getElementById("prev-move-btn").style.display="inline-block",console.log("[recordMove] prev-display",document.getElementById("prev-move-btn").style.display),document.getElementById("next-move-btn").style.display="none"),currentMoveIndex=moveHistory.length-1,updateMoveList()}function updateMoveList(){const e=moveHistory.map((t,n)=>`${n+1}. ${t.player==="black"?"\u25CF":"\u25CB"}${t.moveNotation}`);moveListElement.textContent=e.join(`
`),moveListElement.scrollTop=moveListElement.scrollHeight}function serializeMoveHistory(){return moveHistory.map(e=>`${e.player[0]}${e.row}${e.col}`).join("-")}window.deserializeMoveHistory=function(e){const t=e.split("-");t[t.length-1]===""&&t.pop(),moveHistory=[],moveHistory=t.map(n=>{const o=parseInt(n[1]),l=parseInt(n[2]),i=n[0]==="b"?"black":"white";return{row:o,col:l,player:i,moveNotation:`${"abcdefgh"[l]}${o+1}`,token:"deserialize"}})};function updateURL(){const e=serializeMoveHistory(),t=new URL(window.location);let n=`/${gameMode}/`;gameMode==="player"&&(n="/"),window.location.pathname.split("/").filter(Boolean)[0]==="en"&&(n="en"+n),t.pathname=n,t.searchParams.set("moves",e),t.searchParams.set("timeLimit",timeLimit),t.searchParams.set("showValidMoves",showValidMoves),t.searchParams.set("aiLevel",aiLevel),history.pushState(null,"",t)}function loadBoardFromURL(){const e=new URLSearchParams(window.location.search),t=e.get("moves"),n=e.get("timeLimit"),o=e.get("showValidMoves"),l=window.location.pathname.split("/").filter(Boolean);let i=l[0]||"player";if(l[0]==="en"&&(i=l[1]||"player"),!navigator.onLine&&i==="online"){const r=langCode==="en"?"/en/offline.html":"/offline.html";window.location.href=r;return}e.get("moves")===null&&(document.getElementById("prev-move-btn").style.display="none"),localStorage.getItem("deleted_urls")===null||JSON.parse(localStorage.getItem("deleted_urls")).length===0?document.getElementById("next-move-btn").style.display="none":document.getElementById("next-move-btn").style.display="inline-block";const a=e.get("won"),s=e.get("aiLevel");if(a==="won"&&(timeLimit=0,stopTimer()),i){if(gameMode=i,localStorage.setItem("gameMode",gameMode),document.querySelectorAll(".mode-btn").forEach(r=>{r.classList.remove("active"),r.dataset.mode===gameMode&&r.classList.add("active")}),gameMode==="ai")document.getElementById("level_ai").style.display="block";else{document.getElementById("level_ai").style.display="none";const r=new URL(window.location);r.searchParams.delete("aiLevel"),history.replaceState(null,"",r)}if(gameMode==="online")console.log(`timelimit: ${timeLimit}`),online=!0,onlineUI(),document.getElementById("playerJoinSoundBox").style.display="block";else{n&&(timeLimit=parseInt(n),timeLimit===0?document.getElementById("timeLimitBox_").style.display="none":document.getElementById("timeLimitBox_").style.display="block"),s&&(aiLevel=parseInt(s),localStorage.setItem("aiLevel",aiLevel),minimax_depth=aiLevel-4,minimax_depth<0&&(minimax_depth=0)),o&&(showValidMoves=o==="true");const r=new URL(window.location);r.searchParams.delete("room"),history.replaceState(null,"",r),online=!1,socket&&(socket.close(),socket=null),document.getElementById("playerJoinSoundBox").style.display="none"}}if(document.getElementById("timeLimitSelect").value=timeLimit,document.getElementById("aiLevelSelect").value=aiLevel,document.getElementById("showValidMovesCheckbox").checked=!!showValidMoves,updateStatus(),t){if(gameMode!=="online"&&(deserializeMoveHistory(t),replayMovesUpToIndex(moveHistory.length-1),a)){switch(e.get("w")){case"y":endGame("offline",a,1);break;default:endGame("offline",a);break}timeLimit=0}return!0}else return!1}function onlineUI(){document.getElementById("timeLimitContainer").style.display="none",document.getElementById("validContainer").style.display="none"}function copyURLToClipboard(e=!1,t=!1){let n=new URL(window.location),o=lang.copy_url,l;if(online&&(onlineGameStarted?o=lang.copy_spec:o=lang.copy_invite),e||n.searchParams.set("won",share_winner),t)switch(o=lang.copy_result,n.searchParams.delete("timeLimit"),gameMode==="online"?(n.searchParams.delete("room"),l=n.toString().replace(/\/online\//,"/")):l=n.toString(),langCode){case"en":l=`${ifVictory?"Victory!":"Defeated..."}
I played against ${opponentName} and ${ifVictory?"won":"lost"} by ${Math.abs(scoreB.textContent-scoreW.textContent)} points.

\u3010Final Score\u3011 \u26AB\uFE0F ${scoreB.textContent} : ${scoreW.textContent} \u26AA\uFE0F

#ReversiWeb #Othello

\u{1F447} Game record:
${l}`;break;default:l=`${opponentName}\u306B${Math.abs(scoreB.textContent-scoreW.textContent)}\u77F3\u5DEE\u3067\u3010${ifVictory?"\u52DD\u5229":"\u6557\u5317"}\u3011

\u7D50\u679C \u25B6 \u26AB\uFE0F ${scoreB.textContent} vs ${scoreW.textContent} \u26AA\uFE0F

#\u30EA\u30D0\u30FC\u30B7Web #\u30AA\u30BB\u30ED #ReversiWeb

\u{1F447} \u68CB\u8B5C\u306F\u3053\u3061\u3089\uFF01
${l}`;break}else l=n.toString();navigator.clipboard.writeText(l).then(()=>{alert(o)}).catch(i=>{alert(lang.copy_failed),console.error("Failed to copy URL: ",i)})}function restart(e=!0){if(online){timeLimit=0,localStorage.setItem("timeLimit",timeLimit);const t=Math.random().toString(36).substring(2,8);let n=`${window.location.origin}/online/?room=${t}`;window.location.pathname.split("/").filter(Boolean)[0]==="en"&&(n=`${window.location.origin}/en/online/?room=${t}`),console.log(`[restart] New room URL: ${n}`),e?window.location.href=n:(gameRoom=t,history.replaceState(null,"",n))}else{let t=`${window.location.origin}/${gameMode}/`;gameMode==="player"&&(t=`${window.location.origin}/`),window.location.pathname.split("/").filter(Boolean)[0]==="en"&&(t=`${window.location.origin}/en/${gameMode}/`,gameMode==="player"&&(t=`${window.location.origin}/en/`)),localStorage.setItem("deleted_urls",JSON.stringify([])),window.location.href=t}}function goToPreviousMove(){const e=new URL(window.location),t=e.searchParams.get("moves");if(t.length>3?e.searchParams.set("moves",t.slice(0,t.lastIndexOf("-"))):e.searchParams.delete("moves"),localStorage.getItem("deleted_urls")===null)localStorage.setItem("deleted_urls",JSON.stringify([t.slice(t.lastIndexOf("-")+1)]));else{let n=JSON.parse(localStorage.getItem("deleted_urls"));n.push(t.slice(t.lastIndexOf("-")+1)),localStorage.setItem("deleted_urls",JSON.stringify(n))}sessionStorage.setItem("scrollY",window.scrollY),window.gtag?gtag("event","go_to_previous_move",{event_category:"navigation",event_label:t.slice(t.lastIndexOf("-")+1)}):console.log("[goToPreviousMove] gtag not found"),e.searchParams.delete("w"),window.location=e}function goToNextMove(){const e=new URL(window.location),t=e.searchParams.get("moves")?e.searchParams.get("moves")+"-":"",n=JSON.parse(localStorage.getItem("deleted_urls"));n.length>0&&(e.searchParams.set("moves",t+n.pop()),localStorage.setItem("deleted_urls",JSON.stringify(n)),sessionStorage.setItem("scrollY",window.scrollY),window.gtag?gtag("event","go_to_next_move",{event_category:"navigation",event_label:n.pop()}):console.log("[goToNextMove] gtag not found"),window.location=e)}window.replayMovesUpToIndex=function(e,t=!1){gameBoard=gameBoard.map(n=>n.map(()=>"")),setInitialStones(),console.log("replayMovesUpToIndex",moveHistory),moveHistory.slice(0,e).forEach(({row:n,col:o,player:l})=>{applyServerMove(n,o,l,1)}),e>=0&&applyServerMove(moveHistory[e].row,moveHistory[e].col,moveHistory[e].player,1,t),updateStatus()};function changeTitle(){if(gameMode==="ai"){try{document.getElementById("title").innerHTML='<span id="ai-level-display">'+document.getElementById("aiLevelSelect").options[aiLevelSelect.selectedIndex].text+" AI</span>"}catch{document.getElementById("title").innerHTML='<span id="ai-level-display">\u{1F60E} Level '+aiLevel+" AI</span>"}document.getElementById("level_ai").style.display="block"}else gameMode==="player"?(document.getElementById("title").textContent=player_h1,document.getElementById("level_ai").style.display="none"):gameMode==="online"&&(document.getElementById("title").textContent="Loading...",document.getElementById("level_ai").style.display="none")}function showLoading(e=1e3){setTimeout(()=>{const t=document.createElement("div");t.id="loading-overlay",t.innerHTML=`
        <div class="loading-container">
            <div class="loading-disc">
                <div class="disc-inner"></div>
            </div>
            <div class="loading-text">Loading...</div>
        </div>
    `,document.body.appendChild(t)},e)}window.endGame=function(e,t=null,n=-1){n===1?ifVictory=!0:ifVictory=!1;const o=gameBoard.flat().filter(s=>s==="black").length,l=gameBoard.flat().filter(s=>s==="white").length;let i;if(gameEnded=!0,gameMode==="ai")try{opponentName=aiLevelSelect.options[aiLevelSelect.selectedIndex].text+(aiLevel>9?"":" AI")}catch{opponentName=`\u{1F60E} Level ${aiLevel} AI`}t==="won"?(share_winner="won",o>l?i=lang.winner+lang.black:l>o?i=lang.winner+lang.white:i=lang.draw):e!=="offline"?(e.winner===role_online&&launchConfetti(),e.reason==="surrender"?(share_winner=e.winner,i=lang.surrender_winner+(e.winner==="black"?lang.black:lang.white),gameEndSoundEnabled&&(e.winner===role_online?(victorySound.currentTime=0,victorySound.play().catch(s=>{console.warn("audio was blocked:",s)})):(defeatSound.currentTime=0,defeatSound.play().catch(s=>{console.warn("audio was blocked:",s)})))):e.reason==="timeout"?(share_winner=e.winner,i=lang.timeout_winner+(e.loser==="black"?lang.white:lang.black),gameEndSoundEnabled&&(e.winner===role_online?(victorySound.currentTime=0,victorySound.play().catch(s=>{console.warn("audio was blocked:",s)})):(defeatSound.currentTime=0,defeatSound.play().catch(s=>{console.warn("audio was blocked:",s)})))):e.reason==="natural"&&(share_winner="won",i=lang.winner+(e.winner==="black"?lang.black:lang.white),gameEndSoundEnabled&&(e.winner===role_online?(victorySound.currentTime=0,victorySound.play().catch(s=>{console.warn("audio was blocked:",s)})):(defeatSound.currentTime=0,defeatSound.play().catch(s=>{console.warn("audio was blocked:",s)}))))):t?(i=lang.timeout_winner+(t==="black"?lang.black:lang.white),share_winner=t,t==="white"&&gameMode==="ai"?gameEndSoundEnabled&&(defeatSound.currentTime=0,defeatSound.play().catch(s=>{console.warn("audio was blocked:",s)})):(gameEndSoundEnabled&&(victorySound.currentTime=0,victorySound.play().catch(s=>{console.warn("audio was blocked:",s)})),launchConfetti())):(share_winner="won",o>l?(i=lang.winner+lang.black,gameEndSoundEnabled&&(victorySound.currentTime=0,victorySound.play().catch(s=>{console.warn("audio was blocked:",s)})),launchConfetti()):l>o?(i=lang.winner+lang.white,gameMode==="ai"?gameEndSoundEnabled&&(defeatSound.currentTime=0,defeatSound.play().catch(s=>{console.warn("audio was blocked:",s)})):(gameEndSoundEnabled&&(victorySound.currentTime=0,victorySound.play().catch(s=>{console.warn("audio was blocked:",s)})),launchConfetti())):(i=lang.draw,gameMode==="ai"?gameEndSoundEnabled&&(defeatSound.currentTime=0,defeatSound.play().catch(s=>{console.warn("audio was blocked:",s)})):(gameEndSoundEnabled&&(victorySound.currentTime=0,victorySound.play().catch(s=>{console.warn("audio was blocked:",s)})),launchConfetti()))),document.getElementById("score_display").innerHTML=`${i} | <span id="black_circle"></span> ${o} : ${l} <span id="white_circle"></span>`,typeof gtag<"u"&&gtag("event","game_result",{result:ifVictory,gameMode,player_id:playerId,timeLimit,showValidMoves,aiLevel,gameEndSoundEnabled,placeStoneSoundEnabled:soundEffects,playerJoinSoundEnabled,timeLimitSoundEnabled}),url=new URL(window.location),url.searchParams.set("won",share_winner),ifVictory&&url.searchParams.set("w","y"),history.pushState(null,"",url);const a=share_winner==="won"?o>l?"black":"white":share_winner;if(stopTimer(),(t!=="won"||n!==-1)&&showResultPopup(ifVictory,o,l,a),t!=="won"){const s=document.getElementById("aiLevelSelect").value;gameMode==="ai"&&ifVictory&&window.unlockNextAiLevel&&window.unlockNextAiLevel(s),setTimeout(()=>{gameFinishedCount++,localStorage.setItem("gameFinishedCount",gameFinishedCount),(gameFinishedCount===1&&deferredPrompt||gameFinishedCount===3&&deferredPrompt)&&showInstallPrompt(),isIOS()&&!window.navigator.standalone&&gameFinishedCount===1||isIOS()&&!window.navigator.standalone&&gameFinishedCount===3?iOSinstallGuide():gameMode==="ai"&&ifVictory&&window.unlockNextAiLevel&&window.congratsNextAiLevel(s)},2e3)}};function launchConfetti(){const e=board.getBoundingClientRect(),t=window.innerHeight,n=(e.top+e.height)/t;ifVictory=!0,!(typeof confetti>"u")&&(confetti({particleCount:150,angle:75,spread:100,gravity:.2,origin:{x:0,y:n},colors:["#165B33","#BB2528","#146B3A","#EA4630"],shapes:["square","circle"],scalar:.8,zIndex:100}),setTimeout(()=>{confetti({particleCount:150,angle:105,spread:100,gravity:.2,origin:{x:1,y:n},colors:["#165B33","#BB2528","#146B3A","#EA4630"],shapes:["square","circle"],scalar:.8,zIndex:100})},800))}function preloadResultImages(){["https://reversi.yuki-lab.com/static/game/images/win.png","https://reversi.yuki-lab.com/static/game/images/lose.png","https://reversi.yuki-lab.com/static/game/images/draw.png","https://reversi.yuki-lab.com/static/game/images/laurel.webp"].forEach(t=>{const n=new Image;n.src=t})}function showResultPopup(e,t,n,o){const l=t===n?share_winner==="won":!1;let i="";switch(e?i="https://reversi.yuki-lab.com/static/game/images/win.png":l?(i="https://reversi.yuki-lab.com/static/game/images/draw.png",rOverlay.style.backgroundImage="none"):(i="https://reversi.yuki-lab.com/static/game/images/lose.png",rOverlay.style.backgroundImage="none"),langCode){case"en":l?rMessage.textContent=`\u{1F91D} You drew with ${opponentName}`:rMessage.textContent=(e?"\u{1F3C6}\uFE0F ":"")+(typeof opponentName>"u"?o==="black"?"Black":"White":"You")+(e?" won":" lost")+(typeof opponentName>"u"?"":` against ${opponentName}`)+` by ${Math.abs(t-n)} points!`;break;default:rMessage.textContent=(e?"\u{1F3C6}\uFE0F ":"")+(typeof opponentName>"u"?o==="black"?"\u9ED2\u304C":"\u767D\u304C":`${opponentName}\u306B`)+`${Math.abs(t-n)}\u70B9\u5DEE\u3067${ifVictory?"\u52DD\u5229\uFF01":l?"\u5F15\u304D\u5206\u3051":"\u6557\u5317"}`;break}scoreDiff.textContent=`\u26AB\uFE0F ${t} : ${n} \u26AA\uFE0F`,resultImg.src=i,rPopup.style.display="block",rBoverlay.style.display="block"}function iOSinstallGuide(){document.getElementById("ios-install-guide").style.display="block"}function showInstallPrompt(){deferredPrompt.prompt(),deferredPrompt.userChoice.then(()=>{deferredPrompt=null})}function changeHead(){let e,t,n;gameMode==="ai"?(e=ai_title,t=lang.ai_description,n="https://reversi.yuki-lab.com/ai/"):gameMode==="player"?(e=player_title,t=lang.player_description,n="https://reversi.yuki-lab.com/"):gameMode==="online"?(e=online_title,t=lang.online_description,n="https://reversi.yuki-lab.com/online/"):(e=else_title,t=lang.else_description,n="https://reversi.yuki-lab.com/"),document.title=e;let o=document.querySelector('meta[name="description"]');o||(o=document.createElement("meta"),o.setAttribute("name","description"),document.head.appendChild(o)),o.setAttribute("content",t);let l=document.querySelector("link[rel='canonical']");l||(l=document.createElement("link"),l.setAttribute("rel","canonical"),document.head.appendChild(l)),l.setAttribute("href",n)}function loadGoogleAnalytics(){var e=document.createElement("script");e.src="https://www.googletagmanager.com/gtag/js?id=G-4JKZC3VNE7",e.async=!0,e.nonce=cspNonce,document.head.appendChild(e),window.dataLayer=window.dataLayer||[],window.gtag=function(){dataLayer.push(arguments)},e.onload=function(){gtag("js",new Date),gtag("config","G-4JKZC3VNE7",{cookie_domain:"auto"})},"requestIdleCallback"in window?requestIdleCallback(loadLater):setTimeout(loadLater,1e3)}function loadLater(){(function(e,t,n,o,l,i,a){console.log("Clarity script loaded"),e[n]=e[n]||function(){(e[n].q=e[n].q||[]).push(arguments)},i=t.createElement(o),i.async=1,i.src="https://www.clarity.ms/tag/"+l,i.nonce=cspNonce,a=t.getElementsByTagName(o)[0],a.parentNode.insertBefore(i,a)})(window,document,"clarity","script","qy90xxylfc"),gameMode==="player"&&(aiModulePromise=import(aiPath)),preloadResultImages()}victorySound.volume=.013,defeatSound.volume=.012,warningSound.volume=.08,playerJoin.volume=.1,timeLimit===0?document.getElementById("timeLimitBox_").style.display="none":document.getElementById("timeLimitBox_").style.display="block",document.readyState!=="loading"?(document.removeEventListener("DOMContentLoaded",_DOMContenLoaded),_DOMContenLoaded()):window.addEventListener("DOMContentLoaded",_DOMContenLoaded),document.querySelectorAll(".mode-btn").forEach(e=>{const t=document.querySelectorAll(".mode-btn");e.addEventListener("click",function(){const n=this.getAttribute("data-mode"),o=gameMode;if(n===o)return;gameMode=n,localStorage.setItem("gameMode",n),t.forEach(i=>{i.classList[i===this?"add":"remove"]("active")}),changeTitle(),updateURL(),changeHead();const l=new URL(window.location);n!=="ai"&&(l.searchParams.delete("aiLevel"),history.replaceState(null,"",l)),n==="online"?(online=!0,showLoading(),restart()):(document.getElementById("playerJoinSoundBox").style.display="none",o==="online"?(online=!1,l.searchParams.delete("room"),history.pushState(null,"",l),socket&&(socket.close(),socket=null),showLoading(),restart()):n==="ai"&&(aiModulePromise||(aiModulePromise=import(aiPath)),aiModulePromise.then(i=>{aiModule=i,aiModule.initAIMode(),gameMode==="ai"&&currentPlayer==="white"&&!gameEnded&&aiModule.startAIMove()}).catch(i=>{console.error("Failed to load AI module.",i)}))),document.getElementById("game-container").scrollIntoView({behavior:"smooth"})})});function _DOMContenLoaded(){const e=document.getElementById("qr"),t=document.getElementById("qr-popup"),n=document.getElementById("qrcode");var o=document.getElementById("dynamic-fonts"),l=document.getElementById("dynamic-css");o&&(o.media="all"),l&&(l.media="all");const i=sessionStorage.getItem("scrollY");if(console.log("scrollY",i),i!==null&&(window.scrollTo(0,parseInt(i)),sessionStorage.removeItem("scrollY")),placeStoneBufferPromise=getAudioBuffer(PLACE_STONE_SOUND).then(a=>{console.log("Audio preloaded")}).catch(a=>console.error("Failed to preload audio:",a)),gameMode==="ai"&&(aiModulePromise||(aiModulePromise=import(aiPath),aiModulePromise.then(a=>{a.initAIMode()}).catch(a=>{console.warn("Failed to load AI module.",a)}))),document.getElementById("title").addEventListener("click",function(){gameMode==="ai"||location.reload()}),document.querySelectorAll(".mode-btn").forEach(a=>{a.getAttribute("data-mode")===gameMode&&a.classList.add("active")}),gameMode==="online")e.addEventListener("click",function(){const a=window.location.href;n.innerHTML="",console.log("qr"),new QRCode(n,{text:a,width:200,height:200}),t.style.display="flex",document.addEventListener("click",s=>{!s.target.closest(".qr-popup")&&s.target.id!=="qr-icon"&&(console.log("close"+s.target),t.style.display="none")})}),startMatchBtn.addEventListener("click",function(){copyURLToClipboard(!0)}),onlineUI(),online=!0,document.getElementById("playerJoinSoundBox").style.display="block",gameRoom===null&&restart(!1);else{online=!1;const a=new URL(window.location);a.searchParams.delete("room"),history.replaceState(null,"",a),socket&&(socket.close(),socket=null),document.getElementById("playerJoinSoundBox").style.display="none",gameMode==="ai"?document.getElementById("level_ai").style.display="block":document.getElementById("level_ai").style.display="none"}fetch("/api/auth-status/").then(a=>a.json()).then(a=>{const s=document.querySelectorAll(".authenticated"),r=document.querySelectorAll(".guest");console.log(`[Auth] ${a}, ${a.is_authenticated}`),a.is_authenticated?(s.forEach(c=>c.style.display="block"),authenticated=!0,localStorage.setItem("loggedInBefore",!0),loggedInBefore=!0):(r.forEach(c=>c.style.display="block"),authenticated=!1)}),fetch("/api/premium-status/").then(a=>a.json()).then(a=>{const s=document.querySelectorAll(".premium"),r=document.querySelectorAll(".free");if(console.log(`[Premium] ${a}, ${a.is_premium}`),a.is_premium){s.forEach(m=>m.style.display="block");const d=document.getElementById("open-portal");d.addEventListener("click",function(m){m.preventDefault();const g=d.textContent;d.textContent="\u231B\uFE0F Loading...",fetch(l_prefix+"/api/create-customer-portal-session/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":csrf_token}}).then(u=>u.json()).then(u=>{setTimeout(()=>{d.textContent=g},3e3),window.location.href=u.url})})}else{if(!window.adsLoaded){window.adsLoaded=!0;var c=document.createElement("script");c.src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-1918692579240633",c.defer=!0,c.nonce=cspNonce,document.head.appendChild(c)}r.forEach(d=>d.style.display="block"),document.getElementById("buy-premium-btn").addEventListener("click",buyPremium)}}),loadGoogleAnalytics()}async function getAudioBuffer(e){if(placeStoneBuffer)return placeStoneBuffer;const n=await(await fetch(e)).arrayBuffer();return placeStoneBuffer=await audioContext.decodeAudioData(n),placeStoneBuffer}async function playStoneSound(){if(audioContext.state==="suspended"&&await audioContext.resume().then(()=>{console.log("AudioContext resumed."),resumed=!0}).catch(o=>{console.warn("Failed to resume AudioContext:",o)}),!placeStoneBuffer)try{await placeStoneBufferPromise}catch(o){console.warn("Buffer failed to load:",o);return}const e=placeStoneBuffer;if(!e)return;const t=audioContext.currentTime;if(resumed)resumed=!1;else if(t-lastPlayTime<.1)return;lastPlayTime=t;const n=audioContext.createBufferSource();n.buffer=e,n.connect(gainNode),n.start(0)}function buyPremium(e){e.preventDefault(),authenticated?(gtag("event","premium_intent",{event_category:"engagement",event_label:"Premium Clicked"}),window.location.href=l_prefix+"/premium-intent/"):loggedInBefore?window.location.href=l_prefix+"/login/?next="+l_prefix+"/premium-intent/":window.location.href=l_prefix+"/signup/?next="+l_prefix+"/premium-intent/"}window.addEventListener("beforeunload",async()=>{audioContext.state!=="closed"&&await audioContext.close()}),window.location.hostname!=="127.0.0.1"&&(console.log("Skipping source maps in production."+window.location.hostname),window.addEventListener("error",e=>{e.filename.includes(".js.map")&&e.preventDefault()})),copyUrlBtn.addEventListener("click",copyURLToClipboard),document.getElementById("r-share-btn").addEventListener("click",()=>{copyURLToClipboard(!1,!0)}),document.getElementById("restart-btn").addEventListener("click",restart),document.getElementById("prev-move-btn").addEventListener("click",goToPreviousMove),document.getElementById("next-move-btn").addEventListener("click",goToNextMove),window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),deferredPrompt=e;const t=document.getElementById("install-btn");t.style.display="block",t.addEventListener("click",showInstallPrompt)}),window.addEventListener("appinstalled",()=>{alert(lang.thanks_install);const e=navigator.userAgent.includes("Chrome")?"Chrome":navigator.userAgent.includes("Safari")?"Safari":navigator.userAgent.includes("Firefox")?"Firefox":"Other";gtag("event","pwa_installed",{event_category:"engagement",event_label:"PWA Installed",browser:e,timestamp:new Date().toISOString(),id:playerId,game_mode:gameMode,gameFinishedCount,Won:ifVictory})}),document.getElementById("showValidMovesCheckbox").addEventListener("change",()=>{showValidMoves=document.getElementById("showValidMovesCheckbox").checked,localStorage.setItem("showValidMoves",showValidMoves),updateStatus(),updateURL()}),document.getElementById("toSetting").addEventListener("click",()=>{document.getElementById("settings").scrollIntoView({behavior:"smooth"}),document.getElementById("menu-toggle").checked=!1}),document.getElementById("close-install-guide").addEventListener("click",()=>{if(document.getElementById("ios-install-guide").style.display="none",gameMode==="ai"&&ifVictory){const e=document.getElementById("aiLevelSelect").value;window.unlockNextAiLevel&&window.congratsNextAiLevel(e)}}),document.addEventListener("click",function(e){document.getElementById("menu-toggle").checked&&!document.getElementById("hamburger-menu").contains(e.target)&&(document.getElementById("menu-toggle").checked=!1)}),document.getElementById("timeLimitSelect").value=timeLimit,document.getElementById("timeLimitSelect").addEventListener("change",()=>{if(timeLimit=parseInt(document.getElementById("timeLimitSelect").value),localStorage.setItem("timeLimit",timeLimit),timeLimit===0)document.getElementById("timeLimitBox_").style.display="none";else{const e=document.getElementById("timer-display");stopTimer(),e.classList.remove("warning1","warning2"),e.style.display="inline-block",e.textContent=formatTime(timeLimit),document.getElementById("timeLimitBox_").style.display="block"}}),document.getElementById("aiLevelSelect").value=aiLevel,document.getElementById("aiLevelSelect").addEventListener("change",()=>{aiLevel=parseInt(document.getElementById("aiLevelSelect").value),localStorage.setItem("aiLevel",aiLevel);const e=new URL(window.location);e.searchParams.set("aiLevel",aiLevel),history.replaceState(null,"",e)}),document.getElementById("soundEffectsCheckbox").addEventListener("change",()=>{soundEffects=document.getElementById("soundEffectsCheckbox").checked,localStorage.setItem("soundEffects",soundEffects)}),document.getElementById("timeLimitSoundCheckbox").addEventListener("change",()=>{timeLimitSoundEnabled=document.getElementById("timeLimitSoundCheckbox").checked,localStorage.setItem("timeLimitSoundEnabled",timeLimitSoundEnabled)}),document.getElementById("playerJoinSoundCheckbox").addEventListener("change",()=>{playerJoinSoundEnabled=document.getElementById("playerJoinSoundCheckbox").checked,localStorage.setItem("playerJoinSoundEnabled",playerJoinSoundEnabled)}),document.getElementById("gameEndSoundCheckbox").addEventListener("change",()=>{gameEndSoundEnabled=document.getElementById("gameEndSoundCheckbox").checked,localStorage.setItem("gameEndSoundEnabled",gameEndSoundEnabled)}),window.addEventListener("popstate",function(e){location.reload()}),document.getElementById("soundEffectsCheckbox").checked=soundEffects,document.getElementById("timeLimitSoundCheckbox").checked=timeLimitSoundEnabled,document.getElementById("gameEndSoundCheckbox").checked=gameEndSoundEnabled,document.getElementById("playerJoinSoundCheckbox").checked=playerJoinSoundEnabled;function collapseResultPopup(){rBoverlay.style.display="none",rPopup.classList.add("collapsed")}function expandResultPopup(){rBoverlay.style.display="block",rPopup.classList.remove("collapsed")}document.getElementById("close-result").addEventListener("click",()=>{document.getElementById("restart-btn").classList.add("shine-button"),collapseResultPopup()}),rPopup.addEventListener("click",e=>{rPopup.classList.contains("collapsed")&&e.target!==document.getElementById("close-result")&&(e.stopPropagation(),expandResultPopup())}),document.getElementById("tweet-result").addEventListener("click",()=>{let e=new URL(window.location);e.searchParams.delete("room"),e.searchParams.delete("timeLimit"),e=e.toString();const t=scoreB.textContent===scoreW.textContent?share_winner==="won":!1;gameMode==="online"&&(e=e.replace(/\/online\//,"/"));let n="";switch(langCode){case"en":t?n=`\u{1F91D} I drew with ${opponentName}!

\u3010Final Score\u3011 \u26AB\uFE0F ${scoreB.textContent} : ${scoreW.textContent} \u26AA\uFE0F

#ReversiWeb #Othello

\u{1F447} Game record:
${e}`:n=`${ifVictory?"Victory!":"Defeated..."}
I ${typeof opponentName>"u"?"":` against ${opponentName} and`} ${ifVictory?"won":"lost"} by ${Math.abs(scoreB.textContent-scoreW.textContent)} points.

\u3010Final Score\u3011 \u26AB\uFE0F ${scoreB.textContent} : ${scoreW.textContent} \u26AA\uFE0F

#ReversiWeb #Othello

\u{1F447} Game record:
${e}`;break;default:n=`${typeof opponentName>"u"?"":`${opponentName}\u306B`}${Math.abs(scoreB.textContent-scoreW.textContent)}\u77F3\u5DEE\u3067\u3010${ifVictory?"\u52DD\u5229":"\u6557\u5317"}\u3011

\u7D50\u679C \u25B6 \u26AB\uFE0F ${scoreB.textContent} vs ${scoreW.textContent} \u26AA\uFE0F

#\u30EA\u30D0\u30FC\u30B7Web #\u30AA\u30BB\u30ED #ReversiWeb

\u{1F447} \u68CB\u8B5C\u306F\u3053\u3061\u3089\uFF01
${e}`;break}const o=`https://twitter.com/intent/tweet?text=${encodeURIComponent(n)}`;window.open(o,"_blank")}),document.getElementById("restart-match").addEventListener("click",()=>{gtag("event","next_match",{event_category:"engagement",event_label:ifVictory?"NextMatch_afterVictory":"NextMatch_afterDefeated",gameEndSoundEnabled}),restart()}),initializeBoard();
